# Система мониторинга состояния плода (CTG Analyzer)

Продвинутая система для анализа кардиотокографии (КТГ) плода в реальном времени. Приложение визуализирует данные КТГ, использует модель машинного обучения для прогнозирования риска гипоксии и автоматически обнаруживает аномальные события, такие как децелерации.

## Основные возможности

*   **Визуализация в реальном времени**: Отображение графика с частотой сердечных сокращений плода (FHR), базовой линией (Baseline) и сокращениями матки (UA).
*   **ML-прогнозирование риска**: Оценка риска гипоксии с помощью ML-модели (LightGBM) и его отображение на интуитивно понятном датчике.
*   **Автоматическое обнаружение событий**: Идентификация и отображение децелераций (замедлений ЧСС) на временной шкале.
*   **Раздельная загрузка данных**: Поддержка загрузки данных ЧСС (BPM) и сокращений (Uterus) из отдельных CSV-файлов.
*   **Управление сессиями**: Возможность создавать новые сессии для анализа и переключаться между существующими, обеспечивая изоляцию данных.
*   **Аутентификация пользователей**: Безопасный вход в систему для защиты данных.
*   **Фоновые задачи**: Использование Celery для периодических задач, таких как очистка старых сессий и генерация отчетов.

## Архитектура системы

Проект построен на современной микросервисной архитектуре и включает в себя следующие компоненты:

*   **Бэкенд (Backend)**:
    *   **Фреймворк**: FastAPI (Python)
    *   **База данных**: PostgreSQL с расширением TimescaleDB для эффективной работы с временными рядами.
    *   **Кэш и брокер сообщений**: Redis для хранения временных данных сессий и для Celery.
    *   **ORM**: SQLAlchemy с Alembic для миграций схемы БД.
    *   **Ключевые модули**:
        *   `packages/ctg_core`: Основная логика обработки сигналов КТГ, извлечения признаков и обнаружения аномалий.
        *   `packages/ctg_ml`: Модули для обучения и инференса ML-модели.

*   **Фронтенд (Frontend)**:
    *   **Фреймворк**: React с TypeScript.
    *   **Сборщик**: Vite.
    *   **Визуализация**: Библиотека ECharts для построения графиков и датчиков.
    *   **Коммуникация**: REST API для загрузки данных и WebSocket для получения обновлений в реальном времени.

*   **Инфраструктура и развертывание**:
    *   **Контейнеризация**: Docker и Docker Compose для простого локального развертывания всего стека (API, UI, Worker, DB, Redis).
    *   **Веб-сервер**: Nginx для обслуживания фронтенда и проксирования запросов к API.

## Установка и запуск

### Вариант 1: С использованием Docker Compose (Рекомендуемый)

Это самый простой способ запустить все сервисы.

**Предварительные требования**:
*   Docker
*   Docker Compose

**Шаги**:
1.  **Клонируйте репозиторий**:
    ```bash
    git clone <your-repository-url>
    cd cardio_analyzer
    ```
2.  **Настройте переменные окружения**:
    Скопируйте файл `.env.example` в `.env`. **Обязательно** измените значение `SECRET_KEY` на уникальную и сложную строку.
    ```bash
    cp .env.example .env
    # Откройте .env и установите новый SECRET_KEY
    ```
3.  **Разместите ML-модель**:
    Поместите ваш файл с ML-моделью (например, `patient_risk_pipeline.pkl`) в директорию `packages/ctg_ml/`. Путь к файлу в `.env` должен быть `ARTIFACTS_PATH=packages/ctg_ml/patient_risk_pipeline.pkl`.

4.  **Запустите все сервисы**:
    ```bash
    docker-compose up -d --build
    ```
5.  **Примените миграции базы данных**:
    Дождитесь, пока контейнер `db` станет здоровым, а затем выполните:
    ```bash
    docker-compose exec api alembic upgrade head
    ```
6.  **Создайте администратора**:
    ```bash
    docker-compose exec api python -m tools.create_admin
    ```
    По умолчанию будут созданы учетные данные: `admin@example.com` / `cardio_anal`.

7.  **Откройте приложение**:
    Перейдите в браузере по адресу `http://localhost`.

### Вариант 2: Локальный запуск без Docker

**Предварительные требования**:
*   Python 3.11+
*   Node.js 20+
*   Запущенные PostgreSQL и Redis.

**Шаги**:
1.  **Настройка бэкенда**:
    ```bash
    # Создайте и активируйте виртуальное окружение
    python -m venv venv
    source venv/bin/activate  # для Linux/macOS
    # venv\Scripts\activate  # для Windows

    # Установите зависимости
    pip install -r requirements.txt
    pip install -r requirements-worker.txt
    ```
2.  **Настройка фронтенда**:
    ```bash
    cd apps/ui
    npm install
    cd ../..
    ```
3.  **Настройка окружения**:
    Скопируйте `.env.example` в `.env` и укажите корректные `DATABASE_URL` и `REDIS_URL` для ваших локальных серверов.

4.  **Настройка базы данных и администратора**:
    ```bash
    # Примените миграции
    alembic upgrade head

    # Создайте администратора
    python -m tools.create_admin
    ```
5.  **Запуск сервисов (в разных терминалах)**:
    *   **API-сервер**:
        ```bash
        uvicorn apps.api.main:app --reload --host 0.0.0.0 --port 8000
        ```
    *   **Фронтенд**:
        ```bash
        cd apps/ui
        npm run dev
        ```
    *   **Celery Worker (опционально)**:
        ```bash
        celery -A apps.worker.worker worker --loglevel=info
        ```
6.  **Откройте приложение**:
    Перейдите в браузере по адресу `http://localhost:5173`.


## Использование приложения

1.  **Вход в систему**: Откройте веб-интерфейс и войдите, используя учетные данные, созданные на этапе установки.
2.  **Создание новой сессии**: Нажмите кнопку **"New Session"**. Это создаст уникальный идентификатор для вашего анализа и очистит предыдущие результаты.
3.  **Выбор файлов**: Выберите один или несколько CSV-файлов для канала **BPM (ЧСС)** и/или канала **Uterus (сокращения)**.
4.  **Загрузка и анализ**: Нажмите кнопку **"Upload Files"**. Система загрузит и обработает данные.
5.  **Просмотр результатов**: На экране отобразятся:
    *   Основной график КТГ.
    *   Датчик с оценкой риска гипоксии.
    *   Список обнаруженных децелераций с их характеристиками.
6.  **Переключение между сессиями**: Если у вас несколько сессий, вы можете выбрать нужную из выпадающего списка, чтобы просмотреть ее результаты.

### Формат CSV-файлов

Каждый загружаемый CSV-файл должен содержать как минимум два столбца:
*   `time_sec` или `ts`: Временная метка (секунды от начала записи или дата/время в формате ISO).
*   `value`: Числовое значение измерения.

**Пример (BPM):**
```csv
time_sec,value
0.0,140.5
0.25,141.2
0.5,142.0
```

## Устранение неполадок

*   **Ошибка "Модель не загружена"**: Убедитесь, что файл `patient_risk_pipeline.pkl` существует и путь к нему в `.env` (`ARTIFACTS_PATH`) указан верно.
*   **WebSocket не подключается**: Проверьте, что API-сервер запущен на порту 8000 и что в `.env` (`CORS_ORIGINS`) указан правильный адрес фронтенда.
*   **Графики не отображаются после загрузки**: Проверьте терминал бэкенда на наличие ошибок. Возможно, загруженные файлы содержат недостаточно данных для анализа (требуется минимум 5 минут записи).